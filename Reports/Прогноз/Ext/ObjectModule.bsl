
Функция ОтчетСформировать() Экспорт
	ТабДокумент = Новый ТабличныйДокумент;
	Если НЕ ЗначениеЗаполнено(Чемпионат) Тогда Возврат ТабДокумент; КонецЕсли;
	
	ТабДокумент.Вывести(ЗаголовокПолучить());
	Макет  = ПолучитьОбщийМакет("ТурнирнаяТаблица");
	
	ТабДокумент.Вывести(Макет.ПолучитьОбласть("Шапка1|Начало"));
	
	ПоказыватьРазницуМячей = ПоказыватьРазницуМячей();
	Итого	= Новый Структура("Место", 0);
	
	Данные	= ДанныеПолучить();
	
	Туры	= Новый Массив;
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка|LL");
	Для Каждого Выборка Из Данные Цикл
		Если Туры.Найти(Выборка.Тур) = Неопределено Тогда
			Туры.Добавить(Выборка.Тур);
			
			ОбластьМакета.Параметры.Заполнить(Выборка);
			ТабДокумент.Присоединить(ОбластьМакета);
		КонецЕсли;
	КонецЦикла;
	ТабДокумент.Присоединить(Макет.ПолучитьОбласть("Шапка|NN"));
	
	Команды	= ТурнирнаяТаблица();
	Пока Команды.Следующий() Цикл
		Итого.Место	= Итого.Место + 1;
		
		ОбластьМакета = Макет.ПолучитьОбласть("Детали1|Начало");
		ОбластьМакета.Параметры.Заполнить(Команды);
		Если НЕ ПоказыватьРазницуМячей Тогда
			ОбластьМакета.Параметры.Разница	= СтрШаблон("%1-%2", Команды.КоличествоЗабито, Команды.КоличествоПропущено);
		КонецЕсли;
		ОбластьМакета.Параметры.Место	= Итого.Место;
		ТабДокумент.Вывести(ОбластьМакета);
		
		КоличествоОчков	= Команды.КоличествоОчков;
		
		Для Каждого Выборка Из Данные Цикл
			Если Выборка.Команда = Команды.Команда Или Выборка.Противник = Команды.Команда Тогда
				Для Каждого Тур Из Туры Цикл
					мСтроки	= Данные.НайтиСтроки(Новый Структура("Команда,Тур", Команды.Команда, Тур));
					Если мСтроки.Количество() = 0 Тогда
						мСтроки	= Данные.НайтиСтроки(Новый Структура("Противник,Тур", Команды.Команда, Тур));
						Если мСтроки.Количество() = 0 Тогда
							ТабДокумент.Присоединить(Макет.ПолучитьОбласть("Детали1|NN"));
							Продолжить;
						Иначе
							ТекСтрока	= мСтроки.Получить(0);
							ОбластьМакета = Макет.ПолучитьОбласть("Детали2|" + Результат(ТекСтрока.КоличествоОчков, Истина));
							ОбластьМакета.Параметры.Аббревиатура	= ТекСтрока.Аббревиатура + "(A)";
							
							КоличествоОчков	= КоличествоОчков + ?(ТекСтрока.КоличествоОчков=1, 1, ?(ТекСтрока.КоличествоОчков=0, 3, 0));
						КонецЕсли;
					Иначе
						ТекСтрока	= мСтроки.Получить(0);
						ОбластьМакета = Макет.ПолучитьОбласть("Детали2|" + Результат(ТекСтрока.КоличествоОчков));
						ОбластьМакета.Параметры.Аббревиатура	= ТекСтрока.АббревиатураП + "(H)";
						
						КоличествоОчков	= КоличествоОчков + ТекСтрока.КоличествоОчков;
					КонецЕсли;
					ОбластьМакета.Параметры.Регистратор		= ТекСтрока.Ссылка;
					ТабДокумент.Присоединить(ОбластьМакета);
				КонецЦикла;
				ОбластьМакета	= Макет.ПолучитьОбласть("Детали|NN");
				ОбластьМакета.Параметры.КоличествоОчков	= КоличествоОчков;
				ТабДокумент.Присоединить(ОбластьМакета);
				
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	ТабДокумент.ФиксацияСлева	= 11;
	
	Возврат ТабДокумент;
КонецФункции

Функция Результат(КоличествоОчков, Реверс=Ложь)
	Если Реверс Тогда Возврат ?(КоличествоОчков=0, "WW", ?(КоличествоОчков=1, "DD", "LL")); КонецЕсли;
	Возврат ?(КоличествоОчков=0, "LL", ?(КоличествоОчков=1, "DD", "WW"));
КонецФункции

Функция ДанныеПолучить()
	Запрос	= Новый Запрос("ВЫБРАТЬ
	      	               |	МатчКоманды.Ссылка КАК Ссылка,
	      	               |	НАЧАЛОПЕРИОДА(МатчКоманды.Ссылка.Дата, ДЕНЬ) КАК Дата,
	      	               |	МатчКоманды.Ссылка.Тур КАК Тур,
	      	               |	МатчКоманды.Ссылка.Тур.Код КАК ТурКод,
	      	               |	МатчКоманды.Команда КАК Команда,
	      	               |	МатчКоманды.НомерСтроки КАК НомерСтроки
	      	               |ПОМЕСТИТЬ Клубы
	      	               |ИЗ
	      	               |	Документ.Матч.Команды КАК МатчКоманды
	      	               |ГДЕ
	      	               |	МатчКоманды.Ссылка В
	      	               |			(ВЫБРАТЬ
	      	               |				МатчКоманды.Ссылка
	      	               |			ИЗ
	      	               |				Документ.Матч.Команды КАК МатчКоманды
	      	               |			ГДЕ
	      	               |				МатчКоманды.Ссылка.Тур.Владелец = &Чемпионат
	      	               |				И МатчКоманды.Ссылка.Проведен = ЛОЖЬ
	      	               |				И МатчКоманды.Ссылка.ПометкаУдаления = ЛОЖЬ
	      	               |			СГРУППИРОВАТЬ ПО
	      	               |				МатчКоманды.Ссылка
	      	               |			ИМЕЮЩИЕ
	      	               |				МАКСИМУМ(МатчКоманды.НомерСтроки) = 2)
	      	               |	И (&Все
	      	               |			ИЛИ МатчКоманды.Ссылка.Тур В
	      	               |				(ВЫБРАТЬ ПЕРВЫЕ 5
	      	               |					Туры.Ссылка КАК Ссылка
	      	               |				ИЗ
	      	               |					Справочник.Туры КАК Туры
	      	               |						ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТурнирнаяТаблица КАК ТурнирнаяТаблица
	      	               |						ПО
	      	               |							Туры.Ссылка = ТурнирнаяТаблица.Тур
	      	               |				ГДЕ
	      	               |					Туры.Владелец = &Чемпионат
	      	               |					И Туры.ПометкаУдаления = ЛОЖЬ
	      	               |					И ТурнирнаяТаблица.Тур ЕСТЬ NULL
	      	               |				УПОРЯДОЧИТЬ ПО
	      	               |					Туры.Код))
	      	               |;
	      	               |
	      	               |////////////////////////////////////////////////////////////////////////////////
	      	               |ВЫБРАТЬ
	      	               |	ВТ.Команда КАК Команда,
	      	               |	ВТ.Игрок КАК Игрок,
	      	               |	ВТ.НомерСтроки + ВЫБОР
	      	               |		КОГДА ВТ.Фаза1 <= 23 / 4
	      	               |			ТОГДА ВТ.Фаза1 * 25 / 23
	      	               |		КОГДА ВТ.Фаза1 <= 23 / 2
	      	               |			ТОГДА (23 / 4 - (ВТ.Фаза1 - 23 / 4)) * 25 / 23
	      	               |		КОГДА ВТ.Фаза1 <= 23 / 4 * 3
	      	               |			ТОГДА -(ВТ.Фаза1 - 23 / 2) * 25 / 23
	      	               |		ИНАЧЕ -(23 / 4 - (ВТ.Фаза1 - 23 / 4 * 3)) * 25 / 23
	      	               |	КОНЕЦ КАК Фаза1,
	      	               |	ВТ.НомерСтроки + ВЫБОР
	      	               |		КОГДА ВТ.Фаза2 <= 28 / 4
	      	               |			ТОГДА ВТ.Фаза2 * 25 / 28
	      	               |		КОГДА ВТ.Фаза2 <= 28 / 2
	      	               |			ТОГДА (28 / 4 - (ВТ.Фаза2 - 28 / 4)) * 25 / 28
	      	               |		КОГДА ВТ.Фаза2 <= 28 / 4 * 3
	      	               |			ТОГДА -(ВТ.Фаза2 - 28 / 2) * 25 / 28
	      	               |		ИНАЧЕ -(28 / 4 - (ВТ.Фаза2 - 28 / 4 * 3)) * 25 / 28
	      	               |	КОНЕЦ КАК Фаза2,
	      	               |	ВТ.НомерСтроки + ВЫБОР
	      	               |		КОГДА ВТ.Фаза3 <= 33 / 4
	      	               |			ТОГДА ВТ.Фаза3 * 25 / 33
	      	               |		КОГДА ВТ.Фаза3 <= 33 / 2
	      	               |			ТОГДА (33 / 4 - (ВТ.Фаза3 - 33 / 4)) * 25 / 33
	      	               |		КОГДА ВТ.Фаза3 <= 33 / 4 * 3
	      	               |			ТОГДА -(ВТ.Фаза3 - 33 / 2) * 25 / 33
	      	               |		ИНАЧЕ -(33 / 4 - (ВТ.Фаза3 - 33 / 4 * 3)) * 25 / 33
	      	               |	КОНЕЦ КАК Фаза3,
	      	               |	ВТ.Тур КАК Тур
	      	               |ПОМЕСТИТЬ ВТ
	      	               |ИЗ
	      	               |	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	      	               |		Клубы.Команда КАК Команда,
	      	               |		ВЫБОР
	      	               |			КОГДА Клубы.НомерСтроки = 1
	      	               |				ТОГДА 10
	      	               |			ИНАЧЕ 9
	      	               |		КОНЕЦ КАК НомерСтроки,
	      	               |		Игроки.Игрок КАК Игрок,
	      	               |		РАЗНОСТЬДАТ(Игроки.Игрок.ДатаРождения, Клубы.Дата, ДЕНЬ) - 23 * ЦЕЛ(РАЗНОСТЬДАТ(Игроки.Игрок.ДатаРождения, Клубы.Дата, ДЕНЬ) / 23) КАК Фаза1,
	      	               |		РАЗНОСТЬДАТ(Игроки.Игрок.ДатаРождения, Клубы.Дата, ДЕНЬ) - 28 * ЦЕЛ(РАЗНОСТЬДАТ(Игроки.Игрок.ДатаРождения, Клубы.Дата, ДЕНЬ) / 28) КАК Фаза2,
	      	               |		РАЗНОСТЬДАТ(Игроки.Игрок.ДатаРождения, Клубы.Дата, ДЕНЬ) - 33 * ЦЕЛ(РАЗНОСТЬДАТ(Игроки.Игрок.ДатаРождения, Клубы.Дата, ДЕНЬ) / 33) КАК Фаза3,
	      	               |		Клубы.Тур КАК Тур
	      	               |	ИЗ
	      	               |		РегистрСведений.ПеремещенияИгроков.СрезПоследних(, Игрок.ПометкаУдаления = ЛОЖЬ) КАК Игроки
	      	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Клубы КАК Клубы
	      	               |			ПО Игроки.Команда = Клубы.Команда) КАК ВТ
	      	               |;
	      	               |
	      	               |////////////////////////////////////////////////////////////////////////////////
	      	               |ВЫБРАТЬ
	      	               |	Матчи.Ссылка КАК Ссылка,
	      	               |	Матчи.Тур КАК Тур,
	      	               |	Матчи.ТурКод КАК ТурКод,
	      	               |	Матчи.Команда КАК Команда,
	      	               |	Матчи.Команда.Аббревиатура КАК Аббревиатура,
	      	               |	ВЫБОР
	      	               |		КОГДА ВТ.Фаза1 + ВТ.Фаза2 + ВТ.Фаза3 - ВТ2.Фаза1 - ВТ2.Фаза2 - ВТ2.Фаза3 >= 4
	      	               |			ТОГДА 3
	      	               |		КОГДА ВТ.Фаза1 + ВТ.Фаза2 + ВТ.Фаза3 - ВТ2.Фаза1 - ВТ2.Фаза2 - ВТ2.Фаза3 <= -4
	      	               |			ТОГДА 0
	      	               |		ИНАЧЕ 1
	      	               |	КОНЕЦ КАК КоличествоОчков,
	      	               |	Противники.Команда КАК Противник,
	      	               |	Противники.Команда.Аббревиатура КАК АббревиатураП
	      	               |ИЗ
	      	               |	Клубы КАК Матчи
	      	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	      	               |			ВТ.Тур КАК Тур,
	      	               |			ВТ.Команда КАК Команда,
	      	               |			СРЕДНЕЕ(ВТ.Фаза1) КАК Фаза1,
	      	               |			СРЕДНЕЕ(ВТ.Фаза2 * 1.2) КАК Фаза2,
	      	               |			СРЕДНЕЕ(ВТ.Фаза3 * 1.1) КАК Фаза3
	      	               |		ИЗ
	      	               |			ВТ КАК ВТ
	      	               |		
	      	               |		СГРУППИРОВАТЬ ПО
	      	               |			ВТ.Команда,
	      	               |			ВТ.Тур) КАК ВТ
	      	               |		ПО Матчи.Тур = ВТ.Тур
	      	               |			И Матчи.Команда = ВТ.Команда
	      	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Туры КАК Туры
	      	               |		ПО Матчи.Тур = Туры.Ссылка
	      	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Клубы КАК Противники
	      	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	      	               |				ВТ.Тур КАК Тур,
	      	               |				ВТ.Команда КАК Команда,
	      	               |				СРЕДНЕЕ(ВТ.Фаза1) КАК Фаза1,
	      	               |				СРЕДНЕЕ(ВТ.Фаза2 * 1.2) КАК Фаза2,
	      	               |				СРЕДНЕЕ(ВТ.Фаза3 * 1.1) КАК Фаза3
	      	               |			ИЗ
	      	               |				ВТ КАК ВТ
	      	               |			
	      	               |			СГРУППИРОВАТЬ ПО
	      	               |				ВТ.Команда,
	      	               |				ВТ.Тур) КАК ВТ2
	      	               |			ПО Противники.Тур = ВТ2.Тур
	      	               |				И Противники.Команда = ВТ2.Команда
	      	               |		ПО Матчи.Ссылка = Противники.Ссылка
	      	               |			И Матчи.НомерСтроки <> Противники.НомерСтроки
	      	               |ГДЕ
	      	               |	Матчи.НомерСтроки = 1
	      	               |
	      	               |УПОРЯДОЧИТЬ ПО
	      	               |	Тур
	      	               |АВТОУПОРЯДОЧИВАНИЕ");
	Запрос.УстановитьПараметр("Чемпионат",			Чемпионат);
	//СерверныйФункции.СправочникПередУдалением(
	Запрос.УстановитьПараметр("Все",				Все);
	Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

Функция ЗаголовокПолучить()
	Возврат СерверныйФункции.ЗаголовокПолучить(Новый Структура("Лига,Чемпионат,ВыводитьЧемпионат", Чемпионат.Владелец, Чемпионат, Ложь));
КонецФункции

Функция ТурнирнаяТаблица()
	Возврат СерверныйФункции.ТурнирнаяТаблица(Чемпионат);
КонецФункции

Функция ПоказыватьРазницуМячей()
	Возврат СерверныйФункции.ПоказыватьРазницуМячей();
КонецФункции
